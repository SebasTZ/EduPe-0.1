{% extends "base.html" %}

{% block title %}EduPe - Recursos Educativos{% endblock %}

{% block content %}
<section class="resource-section">
    <h1>Recursos Educativos</h1>

    <!-- New buttons for API access -->
    <div class="api-buttons">
        <button id="gpt-btn" class="btn-api">Usar GPT</button>
        <button id="youtube-btn" class="btn-api">Usar YouTube</button>
        <button id="google-books-btn" class="btn-api">Usar Google Books</button>
    </div>

    <!-- Modal para generar un recurso educativo -->
    <div id="recurso-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>Generar Nuevo Recurso</h2>
            <form id="crear-recurso-form">
                <label for="tema">Tema:</label>
                <input type="text" id="tema" name="tema" required>
                <button type="submit" class="btn-submit">Generar</button>
            </form>
        </div>
    </div>

    <!-- Aquí se muestran los recursos generados -->
    {% if recursos %}
        <ul class="resource-list">
            {% for recurso in recursos %}
                <li>
                    <h3>{{ recurso.title }}</h3>
                    <p>{{ recurso.description }}</p>
                    <a href="{{ recurso.link }}" target="_blank">Acceder al recurso</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay recursos disponibles.</p>
    {% endif %}
</section>

<style>
    /* General Styles */
    .resource-section {
        margin: 20px;
    }
    .resource-list {
        list-style-type: none;
        padding: 0;
    }
    .resource-list li {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .resource-list h3 {
        margin-top: 0;
    }
    .resource-list a {
        color: #007bff;
        text-decoration: none;
    }
    .resource-list a:hover {
        text-decoration: underline;
    }
    .btn-crear-recurso {
        margin-bottom: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }
    .btn-crear-recurso:hover {
        background-color: #218838;
    }
    .btn-api {
        margin-right: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }
    .btn-api:hover {
        background-color: #0056b3;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        max-width: 500px;
        border-radius: 8px;
    }
    .close {
        float: right;
        font-size: 1.5em;
        cursor: pointer;
    }
    .btn-submit {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }
    .btn-submit:hover {
        background-color: #0056b3;
    }
</style>

<script>
    // Abrir y cerrar modal
    const crearRecursoBtn = document.getElementById("crear-recurso-btn");
    const recursoModal = document.getElementById("recurso-modal");
    function abrirModal() { recursoModal.style.display = "block"; }
    function cerrarModal() { recursoModal.style.display = "none"; }
    crearRecursoBtn.onclick = abrirModal;

    // Enviar el formulario para generar el recurso
    document.getElementById("crear-recurso-form").onsubmit = async function(e) {
        e.preventDefault();
        const tema = document.getElementById("tema").value;

        try {
            const [gptResponse, educacionResponse, psicologiaResponse, youtubeResponse, booksResponse] = await Promise.all([
                fetch("/api/generar-recurso", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ tema: tema })
                }),
                fetch("/api/generar-contenido-educacion", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ input: tema })
                }),
                fetch("/api/generar-contenido-psicologia", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ input: tema })
                }),
                fetch(`/api/youtube?query=${tema}`), // YouTube Data API
                fetch(`/api/google-books?query=${tema}`) // Google Books API
            ]);

            const [gptData, educacionData, psicologiaData, youtubeData, booksData] = await Promise.all([
                gptResponse.json(),
                educacionResponse.json(),
                psicologiaResponse.json(),
                youtubeResponse.json(),
                booksResponse.json()
            ]);

            if (gptResponse.ok && educacionResponse.ok && psicologiaResponse.ok && youtubeResponse.ok && booksResponse.ok) {
                alert("Recursos generados exitosamente.");

                let listaRecursos = document.querySelector(".resource-list");
                
                if (!listaRecursos) {
                    listaRecursos = document.createElement("ul");
                    listaRecursos.className = "resource-list";
                    document.querySelector(".resource-section").appendChild(listaRecursos);
                }

                const recursosGenerados = [
                    { title: gptData.resource.title, description: gptData.resource.description, link: gptData.resource.link },
                    { title: "Contenido Educativo", description: educacionData.response, link: "#" },
                    { title: "Contenido Psicológico", description: psicologiaData.response, link: "#" },
                    ...youtubeData.items.map(item => ({
                        title: item.snippet.title,
                        description: item.snippet.description,
                        link: `https://www.youtube.com/watch?v=${item.id.videoId}`
                    })),
                    ...booksData.items.map(item => ({
                        title: item.volumeInfo.title,
                        description: item.volumeInfo.description || "Sin descripción disponible.",
                        link: item.volumeInfo.infoLink
                    }))
                ];

                recursosGenerados.forEach(recurso => {
                    const nuevoRecurso = document.createElement("li");
                    nuevoRecurso.innerHTML = `
                        <h3>${recurso.title}</h3>
                        <p>${recurso.description}</p>
                        <a href="${recurso.link}" target="_blank">Acceder al recurso</a>
                    `;
                    listaRecursos.appendChild(nuevoRecurso);
                });

                cerrarModal();
            } else {
                alert("Hubo un error al generar los recursos.");
            }
        } catch (error) {
            alert("Hubo un error al generar los recursos.");
        }
    };

    // Handle API button clicks
    document.getElementById("gpt-btn").onclick = async function() {
        const tema = document.getElementById("tema").value;
        const response = await fetch("/api/generar-recurso", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tema: tema })
        });
        const data = await response.json();
        if (response.ok) {
            alert("Recurso generado con éxito: " + data.resource.title);
        } else {
            alert("Error al generar recurso: " + data.error);
        }
    };

    document.getElementById("youtube-btn").onclick = async function() {
        const tema = document.getElementById("tema").value;
        const response = await fetch(`/api/youtube?query=${tema}`);
        const data = await response.json();
        if (response.ok) {
            data.items.forEach(item => {
                const nuevoRecurso = document.createElement("li");
                nuevoRecurso.innerHTML = `
                    <h3>${item.snippet.title}</h3>
                    <p>${item.snippet.description}</p>
                    <a href="https://www.youtube.com/watch?v=${item.id.videoId}" target="_blank">Acceder al recurso</a>
                `;
                document.querySelector(".resource-list").appendChild(nuevoRecurso);
            });
            alert("Recursos de YouTube generados con éxito.");
        } else {
            alert("Error al obtener recursos de YouTube: " + data.error);
        }
    };

    document.getElementById("google-books-btn").onclick = async function() {
        const tema = document.getElementById("tema").value;
        const response = await fetch(`/api/google-books?query=${tema}`);
        const data = await response.json();
        if (response.ok) {
            data.items.forEach(item => {
                const nuevoRecurso = document.createElement("li");
                nuevoRecurso.innerHTML = `
                    <h3>${item.volumeInfo.title}</h3>
                    <p>${item.volumeInfo.description || "Sin descripción disponible."}</p>
                    <a href="${item.volumeInfo.infoLink}" target="_blank">Acceder al recurso</a>
                `;
                document.querySelector(".resource-list").appendChild(nuevoRecurso);
            });
            alert("Recursos de Google Books generados con éxito.");
        } else {
            alert("Error al obtener recursos de Google Books: " + data.error);
        }
    };
</script>
{% endblock %}
